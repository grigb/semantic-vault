# Cursor Rule: Debugging Persistent Neo4j Connection Failures in Docker Compose

## Problem
The backend service (`graphiti`) in the Semantic Vault stack was failing to connect to the Neo4j database at `neo4j:7687`, even though:
- Docker Compose networking was working (TCP connection test from the backend container succeeded).
- The credentials and URI were correct and available in the backend container environment.
- Neo4j was running and healthy.

## Solution
1. **Isolate the Problem:**
   - Verified Docker networking with `nc -zv neo4j 7687` from inside the backend container.
   - Verified credentials and driver by running a direct Python Neo4j connection test from inside the backend container (`RETURN 1` query succeeded).
   - Determined that the problem was not with Docker, networking, or authentication.

2. **Root Cause:**
   - The persistent connection failures are likely due to the backend application code initializing the Neo4j driver or connection pool too early (before Neo4j is ready), or lacking robust retry/backoff logic.

3. **Next Steps:**
   - Review and, if necessary, patch the backend code to ensure:
     - Neo4j driver initialization includes robust retry and backoff logic.
     - The application waits for Neo4j to be ready before attempting persistent connections.
   - Confirm by re-running ingestion and search tests after code changes.

## Rule
**Whenever persistent Neo4j connection failures occur in a Docker Compose environment, always:**
- Test connectivity and authentication from inside the backend container.
- If these tests succeed but the application still fails, review the backend code for retry/backoff logic and initialization timing.
- Patch the code to ensure robust connection handling before troubleshooting the environment further.

*Last updated: 2025-04-27*
